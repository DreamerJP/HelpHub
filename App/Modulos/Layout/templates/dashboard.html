{% extends "layout_base.html" %} {% block title %}Dashboard - HelpHub 4.0{%
endblock %} {% block page_title %}Dashboard{% endblock %} {% block head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %} {% block content %}
<!-- Alertas de Tarefas Atrasadas (Servidor offline) -->
{% if current_user.is_authenticated and current_user.is_admin and
TAREFAS_ATRASADAS and not SCHEDULER_ERROR %} {% for tarefa in TAREFAS_ATRASADAS
%}
<div
  style="
    background: #ecfdf5;
    border-left: 4px solid #10b981;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  "
>
  <div style="display: flex; align-items: center; gap: 1rem">
    <i
      class="ph ph-calendar-plus"
      style="color: #059669; font-size: 1.5rem"
    ></i>
    <div>
      <h4
        style="
          color: #064e3b;
          font-weight: 600;
          font-size: 0.875rem;
          margin-bottom: 0.25rem;
        "
      >
        Tarefa Pendente: {{ tarefa.tarefa }}
      </h4>
      <p style="color: #065f46; font-size: 0.75rem; margin: 0">
        A rotina agendada para as 03:00 de hoje não foi realizada.
      </p>
    </div>
  </div>
  <div style="display: flex; gap: 0.5rem">
    {% if tarefa.id == 'backup_diario' %}
    <a
      href="{{ url_for('admin.backups') }}"
      class="btn btn-soft-success btn-sm"
    >
      Ver Backups
    </a>
    <a
      href="{{ url_for('admin.gerar_backup') }}"
      class="btn btn-primary btn-sm"
    >
      <i class="ph ph-play"></i> Fazer Backup
    </a>
    {% elif tarefa.id == 'fechar_pendentes' %}
    <a href="{{ url_for('admin.logs') }}" class="btn btn-soft-success btn-sm">
      Ver Logs
    </a>
    {% endif %}
  </div>
</div>
{% endfor %} {% endif %}

<!-- Grid Principal -->
<div
  style="
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  "
>
  <!-- Chamados Recentes -->
  <div class="glass-panel" style="padding: 1.5rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h3 style="margin: 0">Chamados Recentes</h3>
      <a
        href="{{ url_for('chamados.lista') }}"
        class="btn btn-soft-warning btn-sm"
      >
        Ver Todos
      </a>
    </div>

    {% if chamados_recentes %}
    <div style="display: flex; flex-direction: column; gap: 0.75rem">
      {% for chamado in chamados_recentes %}
      <a
        href="{{ url_for('chamados.detalhe', id=chamado.id) }}"
        style="text-decoration: none; color: inherit"
      >
        <div
          class="card-status-{{ chamado.status | lower }}"
          style="
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.2s ease;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: start;
              margin-bottom: 0.5rem;
            "
          >
            <div style="font-weight: 600; color: var(--text-main)">
              {{ chamado.assunto }}
            </div>
            <span
              class="badge badge-{% if chamado.status == 'Aberto' %}danger{% elif chamado.status == 'Agendado' %}warning{% elif chamado.status == 'Pendente' %}info{% elif chamado.status == 'Escalonado' %}escalonado{% else %}success{% endif %}"
            >
              {{ chamado.status }}
            </span>
          </div>
          <div
            style="
              display: flex;
              gap: 1.5rem;
              font-size: 0.875rem;
              color: var(--text-muted);
            "
          >
            <span><i class="ph ph-hash"></i> {{ chamado.protocolo }}</span>
            <span
              ><i class="ph ph-user"></i> {{ chamado.cliente.nome_razao if
              chamado.cliente else 'N/A' }}</span
            >
            <span
              ><i class="ph ph-calendar"></i> {{
              chamado.created_at.strftime('%d/%m/%Y') }}</span
            >
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: var(--text-muted)">
      <i class="ph ph-ticket" style="font-size: 48px; opacity: 0.3"></i>
      <p style="margin-top: 1rem">Nenhum chamado registrado ainda.</p>
    </div>
    {% endif %}
  </div>

  <!-- Agendamentos de Hoje -->
  <div
    class="glass-panel"
    style="padding: 1.5rem; display: flex; flex-direction: column"
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      "
    >
      <h3 style="margin: 0">Agenda de Hoje</h3>
      <a
        href="{{ url_for('agenda.calendario') }}"
        class="btn btn-soft-warning btn-sm"
      >
        Ver Tudo
      </a>
    </div>

    <div style="margin-bottom: 1.5rem">
      <span
        style="font-size: 0.75rem; color: var(--text-muted); font-weight: 500"
      >
        <i class="ph ph-check-circle" style="color: var(--success)"></i>
        {{ agenda_concluidos }} de {{ agenda_total }} visitas concluídas
      </span>
    </div>

    {% if agendamentos_hoje %}
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 480px;
        overflow-y: auto;
        padding-right: 5px;
      "
    >
      {% for agendamento in agendamentos_hoje %}
      <div
        style="
          padding: 1rem;
          background: #f0f9ff;
          border-radius: 8px;
          border-left: 3px solid var(--primary);
        "
      >
        <div
          style="
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
          "
        >
          {{ agendamento.data_inicio.strftime('%H:%M') }}
        </div>
        <div style="font-size: 0.875rem; color: var(--text-muted)">
          {% if agendamento.chamado %}
          <div
            style="
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            "
          >
            <i class="ph ph-ticket"></i> {{ agendamento.chamado.assunto }}
          </div>
          <div
            style="
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            "
          >
            <i class="ph ph-user"></i> {{ agendamento.chamado.cliente.nome_razao
            if agendamento.chamado.cliente else 'N/A' }}
          </div>
          {% else %} Agendamento sem chamado vinculado {% endif %}
        </div>
      </div>
      {% endfor %} {% if agenda_remanescentes > 0 %}
      <div
        style="
          text-align: center;
          padding: 0.5rem;
          color: var(--text-muted);
          font-size: 0.8rem;
          font-style: italic;
        "
      >
        ... e mais {{ agenda_remanescentes }} visitas agendadas hoje.
      </div>
      {% endif %}
    </div>
    {% else %}

    <div style="text-align: center; padding: 2rem; color: var(--text-muted)">
      <i class="ph ph-calendar-x" style="font-size: 48px; opacity: 0.3"></i>
      <p style="margin-top: 1rem; font-size: 0.875rem">
        Nenhum agendamento para hoje.
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Gráficos -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem">
  <!-- Gráfico de Status -->
  <div class="glass-panel" style="padding: 1.5rem">
    <h3 style="margin-bottom: 1.5rem">Distribuição por Status</h3>
    <div id="chart-status"></div>
  </div>

  <!-- Gráfico de Tendência -->
  <div class="glass-panel" style="padding: 1.5rem">
    <h3 style="margin-bottom: 1.5rem">Histórico de Chamados</h3>
    <div id="chart-tendencia"></div>
  </div>
</div>

<!-- Gráfico de Departamentos (Novo) -->
<div class="glass-panel" style="padding: 1.5rem; margin-top: 1.5rem">
  <h3 style="margin-bottom: 1.5rem">Volume por Departamento</h3>
  <div id="chart-departamentos"></div>
</div>

{% endblock %} {% block scripts %}
<script>
  // Gráfico de Status (Donut Interativo)
  var statusLabels = ['Aberto', 'Agendado', 'Pendente', 'Escalonado', 'Fechado'];
  var statusFilters = ['abertos', 'agendados', 'pendentes', 'escalonados', 'fechados'];
  var statusColors = ['#EF4444', '#F59E0B', '#3B82F6', '#8B5CF6', '#10B981'];

  var optionsStatus = {
    series: [
        {{ stats_status['Aberto'] }},
        {{ stats_status['Agendado'] }},
        {{ stats_status['Pendente'] }},
        {{ stats_status['Escalonado'] }},
        {{ stats_status['Fechado'] }}
    ],
    chart: {
      type: 'donut',
      height: 300,
      events: {
        dataPointSelection: function(event, chartContext, config) {
          var filter = statusFilters[config.dataPointIndex];
          window.location.href = "{{ url_for('chamados.lista') }}?status=" + filter;
        }
      }
    },
    labels: statusLabels,
    colors: statusColors,
    legend: { position: 'bottom' },
    plotOptions: {
      pie: {
        donut: {
          size: '72%',
          labels: {
            show: true,
            total: {
              show: true,
              label: 'Total',
              fontSize: '14px',
              fontWeight: 600,
              formatter: function(w) {
                return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
              }
            }
          }
        }
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return Math.round(val) + "%"
      }
    },
    tooltip: {
        y: {
            formatter: function(val) {
                return val + " chamados"
            }
        }
    }
  };
  var chartStatus = new ApexCharts(document.querySelector("#chart-status"), optionsStatus);
  chartStatus.render();

  // Gráfico de Tendência (Área - 365 dias com Zoom)
  var rawData = {{ tendencia_ano | tojson }};

  // Convertemos para o formato que o ApexCharts DateTime gosta
  var seriesData = rawData.map(function(item) {
    return {
      x: new Date(item.iso).getTime(),
      y: item.total
    };
  });

  var optionsTendencia = {
    series: [{
      name: 'Chamados',
      data: seriesData
    }],
    chart: {
      type: 'area',
      height: 300,
      toolbar: {
        show: true,
        tools: {
            download: false,
            selection: true,
            zoom: '<i class="ph ph-magnifying-glass-plus"></i>',
            zoomin: true,
            zoomout: true,
            pan: true,
            reset: '<i class="ph ph-arrows-counter-clockwise"></i>'
        }
      },
      zoom: {
        enabled: true,
        type: 'x',
        autoScaleYaxis: true
      }
    },
    xaxis: {
      type: 'datetime',
      // Definimos o zoom inicial para os últimos 30 dias (do último ponto para trás)
      min: seriesData[seriesData.length - 1].x - (30 * 24 * 60 * 60 * 1000),
      max: seriesData[seriesData.length - 1].x,
      labels: {
        datetimeFormatter: {
          year: 'yyyy',
          month: 'MMM',
          day: 'dd/MM'
        }
      }
    },
    colors: ['#3B82F6'],
    fill: {
      type: 'gradient',
      gradient: {
        shadeIntensity: 1,
        opacityFrom: 0.7,
        opacityTo: 0.3,
      }
    },
    dataLabels: { enabled: false },
    stroke: { curve: 'smooth', width: 2 },
    tooltip: {
      x: { format: 'dd/MM/yyyy' }
    }
  };
  var chartTendencia = new ApexCharts(document.querySelector("#chart-tendencia"), optionsTendencia);
  chartTendencia.render();

  // Gráfico de Departamentos (Barras)
  var deptData = {{ stats_departamentos | tojson }};
  var deptNames = deptData.map(d => d.nome);
  var deptTotals = deptData.map(d => d.total);

  var optionsDept = {
    series: [{
      name: 'Total de Chamados',
      data: deptTotals
    }],
    chart: {
      type: 'bar',
      height: 300,
      toolbar: { show: false }
    },
    plotOptions: {
      bar: {
        borderRadius: 4,
        horizontal: true,
        barHeight: '50%',
        distributed: true // Cores diferentes pra cada barra
      }
    },
    dataLabels: { enabled: true },
    xaxis: { categories: deptNames },
    colors: ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981'], // Paleta HelpHub
    legend: { show: false }, // Esconde legenda pois nomes ja estao no eixo Y
    tooltip: {
        y: {
            formatter: function (val) { return val + " chamados" }
        }
    }
  };

  if(deptData.length > 0) {
      var chartDept = new ApexCharts(document.querySelector("#chart-departamentos"), optionsDept);
      chartDept.render();
  } else {
      document.querySelector("#chart-departamentos").innerHTML =
          '<div style="text-align:center; padding: 2rem; color: #9ca3af">Sem dados de departamento ainda.</div>';
  }
</script>
{% endblock %}
