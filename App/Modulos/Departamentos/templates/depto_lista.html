{% extends "layout_base.html" %} 
{% from "componentes.html" import render_paginacao, render_layout_erp, th_ordenavel, badge_status_cliente %} 

{% block title %}Departamentos - HelpHub 4.0{% endblock %} 


{% block page_title %}
    Departamentos & Setores 
    <span class="erp-subtitle hidden lg:inline-block">Estrutura organizacional da empresa</span>
{% endblock %}

{% block content %}
{% set toolbar_html %}
    <div x-show="activeTab === 'lista'" x-cloak class="flex items-center gap-2 w-full">
        <a href="{{ url_for('departamentos.novo') }}" class="erp-btn erp-btn-primary">
            <i class="ph ph-plus-circle text-lg"></i> Novo Departamento
        </a>

        <div class="erp-separator"></div>

        <!-- Ações que dependem da seleção -->
        <a :href="selectedItem ? '{{ url_for('departamentos.editar', id=0) }}'.replace('0', selectedItem.id) : '#'"
           :class="selectedItem ? '' : 'disabled'"
           class="erp-btn erp-btn-neutral">
            <i class="ph ph-pencil-simple text-blue-600"></i> Editar
        </a>

        <button :class="selectedItem ? '' : 'disabled'"
                class="erp-btn erp-btn-neutral text-red-600"
                @click="if(selectedItem && await confirmAction('Remover o departamento ' + selectedItem.nome + '?', 'danger')) { alert('Ação de exclusão em breve'); }">
            <i class="ph ph-trash"></i> Excluir
        </button>

        <div class="flex items-center gap-2 ml-auto">
            <div class="erp-badge-count">Total: {{ departamentos|length }}</div>
        </div>
    </div>
{% endset %}

{# --- RENDERIZAÇÃO ERP --- #}
{% call render_layout_erp(
    titulo="Departamentos & Setores",
    subtitulo="Estrutura organizacional da empresa.",
    abas=[
        {'id': 'lista', 'label': 'Departamentos Ativos', 'icon': 'ph-buildings'},
        {'id': 'placeholder', 'label': 'ADD NOVA ABA', 'icon': 'ph-plus-circle'}
    ],
    toolbar_buttons=toolbar_html
) %}

    <!-- Grid de Dados -->
    <div x-show="activeTab === 'lista'" class="erp-grid-content">
        <table class="erp-table">
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    {{ th_ordenavel('Departamento', 'nome', request.args.get('sort'), request.args.get('order')) }}
                    <th>Email de Notificação</th>
                    <th>Responsável</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for depto in departamentos %}
                <tr class="group cursor-pointer select-none"
                    :class="{'selected': selectedItem && selectedItem.id == '{{ depto.id }}'}"
                    @click="toggleSelection({
                        id: '{{ depto.id }}', 
                        nome: '{{ depto.nome | replace("'", "\\'") }}'
                    })"
                    @dblclick="window.location.href = '{{ url_for('departamentos.editar', id=depto.id) }}'">
                    
                    <td class="text-center text-gray-400 font-mono text-xs">{{ depto.id }}</td>
                    <td class="font-semibold text-gray-700">{{ depto.nome }}</td>
                    <td class="text-gray-600"><i class="ph ph-envelope-simple mr-1"></i> {{ depto.email_notificacao or '-' }}</td>
                    <td>-</td> <!-- Placeholder para Responsável -->
                    <td>
                        {{ badge_status_cliente(depto.ativo) }}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-12 text-muted">Nenhum departamento cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Paginação -->
        <!-- NOTA: Se 'departamentos' for uma lista pura e não query PAGINADA, precisamos tratar isso -->
        <!-- Assumindo que departments pode não ser paginado ainda no backend antigo, ocultamos a paginação por segurança se não tiver pages -->
        {% if departamentos.pages is defined %}
        <div class="erp-footer sticky bottom-0">
             {{ render_paginacao(departamentos, 'departamentos.lista') }}
        </div>
        {% else %}
        <div class="erp-footer text-xs justify-end">
            Total: {{ departamentos|length }}
        </div>
        {% endif %}
    </div>
    
    <!-- Aba Placeholder -->
    <div x-show="activeTab === 'placeholder'" class="p-12 text-center text-gray-400">
        <i class="ph ph-plus-circle text-3xl mb-3 block opacity-50"></i>
        <p>Espaço reservado para novas funcionalidades.</p>
    </div>

{% endcall %}

{% endblock %}
