{% extends "layout_base.html" %} {% from "componentes.html" import
render_paginacao, badge_status_chamado, badge_prioridade_chamado,
render_layout_erp, th_ordenavel %} {% block title %}Chamados - HelpHub 4.1{%
endblock %} {% block page_title %} Fila de Chamados
<span class="erp-subtitle hidden lg:inline-block"
  >Centro de operações e suporte ao cliente</span
>
{% endblock %} {% block content %} {# --- BOTÕES DA TOOLBAR --- #} {% set
toolbar_html %}
<!-- Grupo A: Novo -->
<a href="{{ url_for('chamados.novo') }}" class="erp-btn erp-btn-primary">
  <i class="ph ph-plus-circle text-lg"></i> Novo Chamado
</a>

<div class="erp-separator"></div>

<!-- Grupo B: Ações de Contexto -->
<a
  :href="selectedItem ? '{{ url_for('chamados.detalhe', id=0) }}'.replace('0', selectedItem.id) : '#'"
  :class="selectedItem ? '' : 'disabled'"
  class="erp-btn erp-btn-neutral"
>
  <i class="ph ph-arrow-square-out text-blue-600"></i> Abrir
</a>

<!-- Grupo C: Busca -->
<div class="flex items-center gap-2 ml-auto">
  <form
    action="{{ url_for('chamados.lista') }}"
    method="get"
    class="flex items-center"
  >
    <input type="hidden" name="status" value="{{ status_filter }}" />
    <div class="erp-search-box">
      <i class="ph ph-magnifying-glass"></i>
      <input
        type="text"
        name="q"
        value="{{ q or '' }}"
        placeholder="Protocolo, Assunto..."
        class="erp-search-input"
      />
    </div>
  </form>
  <div class="erp-badge-count" title="Total nesta fila">
    {{ chamados.total }} reg.
  </div>
</div>
{% endset %} {# --- RENDERIZAÇÃO ERP --- #} {# Truque do AJAX: 1. Passamos o
status_filter atual como active_tab_id. 2. Usamos x-effect abaixo para ouvir
mudanças na aba e recarregar a página via AJAX. #} {% call render_layout_erp(
titulo="Chamados", abas=[ {'id': 'ativos', 'label': 'Todos Ativos', 'icon':
'ph-envelope'}, {'id': 'abertos', 'label': 'Triagem', 'icon':
'ph-envelope-open'}, {'id': 'agendados', 'label': 'Visitas', 'icon':
'ph-calendar'}, {'id': 'pendentes', 'label': 'Aguardando', 'icon':
'ph-hourglass'}, {'id': 'escalonados', 'label': 'Nível Superior', 'icon':
'ph-trend-up'}, {'id': 'fechados', 'label': 'Finalizados', 'icon':
'ph-check-circle'} ], toolbar_buttons=toolbar_html, active_tab_id=status_filter,
persistir_aba=True
) %}

<!-- Watcher para Navegação de Abas -->
<div
  x-effect="if (activeTab !== '{{ status_filter }}') loadUrl('{{ url_for('chamados.lista') }}?status=' + activeTab + '&q={{ q or '' }}')"
></div>

<!-- Grid de Dados -->
<div class="erp-grid-content">
  <table class="erp-table">
    <thead>
      <tr>
        <th style="width: 120px">Protocolo</th>
        <th>Assunto</th>
        <th>Cliente</th>
        {{ th_ordenavel('Prioridade', 'prioridade', request.args.get('sort'),
        request.args.get('order'), style="width: 110px") }} {{
        th_ordenavel('Departamento', 'departamento_id',
        request.args.get('sort'), request.args.get('order')) }}
        <th style="width: 100px">Status</th>
        {{ th_ordenavel('Criado em', 'created_at', request.args.get('sort'),
        request.args.get('order'), style="width: 140px") }}
        {% if status_filter == 'agendados' %}
        {{ th_ordenavel('Próximo Agend.', 'proximo_agendamento', request.args.get('sort'),
        request.args.get('order'), style="width: 140px") }}
        {% endif %}
        {% if status_filter == 'fechados' %}
        {{ th_ordenavel('Finalizado em', 'updated_at', request.args.get('sort'),
        request.args.get('order'), style="width: 140px") }}
        {% endif %}
        <th>Responsável</th>
      </tr>
    </thead>
    <tbody>
      {% for c in chamados.items %}
      <tr
        class="group cursor-pointer select-none"
        :class="{'selected': selectedItem && selectedItem.id == '{{ c.id }}'}"
        @click="toggleSelection({
                        id: '{{ c.id }}', 
                        protocolo: '{{ c.protocolo }}'
                    })"
        @dblclick="window.location.href = '{{ url_for('chamados.detalhe', id=c.id) }}'"
      >
        <td class="font-mono font-semibold text-blue-700">{{ c.protocolo }}</td>

        <td class="font-medium text-gray-800">{{ c.assunto }}</td>

        <td>{{ c.cliente.nome_razao }}</td>

        <td>{{ badge_prioridade_chamado(c.prioridade) }}</td>

        <td class="text-gray-500 text-xs">
          <i class="ph ph-buildings mr-1"></i>
          {{ c.departamento.nome if c.departamento else 'Triagem' }}
        </td>

        <td>{{ badge_status_chamado(c.status, colorido=False) }}</td>

        <td class="text-xs text-gray-500">{{ c.created_at_br }}</td>
        {% if status_filter == 'agendados' %}
        <td class="text-xs text-gray-500" {% if c.proximo_agendamento and c.proximo_agendamento.esta_atrasado %}style="color: #dc2626 !important;"{% endif %}>
          {{ c.proximo_agendamento.data_inicio_br if c.proximo_agendamento else '-' }}
        </td>
        {% endif %}
        {% if status_filter == 'fechados' %}
        <td class="text-xs text-blue-500 font-medium">{{ c.updated_at_br }}</td>
        {% endif %}

        <td class="text-xs text-gray-400">
          {% if c.tecnico %} {{ c.tecnico.username }} {% else %} - {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="{% if status_filter == 'fechados' or status_filter == 'agendados' %}9{% else %}8{% endif %}" class="text-center py-12 text-muted">
          <i class="ph ph-inbox text-3xl mb-2 block opacity-20"></i>
          Nenhum chamado encontrado nesta fila.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Paginação -->
  <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-2">
    {{ render_paginacao(chamados, 'chamados.lista', status=status_filter, q=q)
    }}
  </div>
</div>

{% endcall %} {% endblock %}
