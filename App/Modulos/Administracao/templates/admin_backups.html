{% extends "layout_base.html" %} {% from "componentes.html" import
render_layout_erp, th_ordenavel, erp_banner %} {% block title %}Backups -
HelpHub 4.0{% endblock %} {% block page_title %} Backups do Sistema
<span class="erp-subtitle hidden lg:inline-block"
  >Cópias de segurança e restauração de dados</span
>
{% endblock %} {% block content %} {# --- ALERTA SCHEDULER --- #} {% if
current_user.is_authenticated and current_user.is_admin and SCHEDULER_ERROR %}
{% call erp_banner(tipo='warning', titulo='Aviso: Agendador de Tarefas Inativo',
icon='ph-warning-diamond') %} O servidor bloqueou threads background ({{
SCHEDULER_ERROR }}).
<strong>Backups automáticos não serão gerados.</strong> Execute manualmente. {%
endcall %} {% endif %} {# --- TOOLBAR --- #} {% set toolbar_html %}
<div x-show="activeTab === 'lista'" x-cloak class="flex items-center gap-2">
  <a
    href="{{ url_for('admin.gerar_backup') }}"
    class="erp-btn erp-btn-primary backup-action"
    data-confirm-message="Gerar um backup agora? O sistema pode travar por alguns segundos."
  >
    <i class="ph ph-database text-lg"></i> Gerar Novo Backup
  </a>

  <div class="erp-separator"></div>

  <button
    :class="selectedItem ? '' : 'disabled'"
    class="erp-btn erp-btn-neutral text-blue-600"
    @click="if(selectedItem) window.location.href = '{{ url_for('admin.download_backup', filename='') }}' + selectedItem.nome"
  >
    <i class="ph ph-download-simple"></i> Baixar
  </button>

  <button
    :class="selectedItem ? '' : 'disabled'"
    class="erp-btn erp-btn-neutral text-red-600"
    @click="if(selectedItem && await confirmAction('Restaurar este backup DESTRUIRÁ os dados atuais. Certeza?', 'danger')) { alert('Restauração segura indisponível nesta versão web.'); }"
  >
    <i class="ph ph-clock-counter-clockwise"></i> Restaurar
  </button>
</div>

<div
  x-show="activeTab === 'servicos'"
  x-cloak
  class="flex items-center gap-2 w-full"
>
  <button
    :class="selectedItem && selectedItem.type === 'job' ? '' : 'disabled'"
    class="erp-btn erp-btn-neutral text-green-600"
    @click="if(selectedItem) loadUrl('{{ url_for('admin.executar_tarefa', id='') }}' + selectedItem.id)"
  >
    <i class="ph ph-play-circle"></i> Executar Agora
  </button>

  <div class="erp-separator"></div>

  <!-- Botão Pausar (Mostra se NÃO estiver pausado) -->
  <template
    x-if="selectedItem && selectedItem.type === 'job' && !selectedItem.pausado"
  >
    <button
      class="erp-btn erp-btn-neutral text-amber-600"
      @click="loadUrl('{{ url_for('admin.pausar_tarefa', id='') }}' + selectedItem.id)"
    >
      <i class="ph ph-pause-circle"></i> Pausar Tarefa
    </button>
  </template>

  <!-- Botão Retomar (Mostra se ESTIVER pausado) -->
  <template
    x-if="selectedItem && selectedItem.type === 'job' && selectedItem.pausado"
  >
    <button
      class="erp-btn erp-btn-neutral text-blue-600"
      @click="loadUrl('{{ url_for('admin.retomar_tarefa', id='') }}' + selectedItem.id)"
    >
      <i class="ph ph-caret-circle-right"></i> Retomar Agendamento
    </button>
  </template>

  <div class="flex items-center gap-2 ml-auto">
    <button class="erp-btn erp-btn-neutral" @click="window.location.reload()">
      <i class="ph ph-arrows-counter-clockwise"></i> Atualizar Status
    </button>
    <div class="erp-badge-count">{{ jobs|length }} tarefas</div>
  </div>
</div>
{% endset %} {# --- LAYOUT ERP --- #} {% call render_layout_erp(
titulo="Backups", abas=[ {'id': 'lista', 'label': 'Arquivos Disponíveis',
'icon': 'ph-hard-drives'}, {'id': 'servicos', 'label': 'Agendador de Tarefas',
'icon': 'ph-timer'} ], toolbar_buttons=toolbar_html,
persistir_aba=True, storage_type='local' ) %}

<!-- Aba 1: Lista de Arquivos -->
<div class="erp-grid-content" x-show="activeTab === 'lista'">
  <div
    class="erp-banner erp-banner-info"
    style="padding: 0.5rem 1rem; margin-bottom: 0.5rem; border-radius: 0"
  >
    <i class="ph ph-info" style="font-size: 1.1rem"></i>
    <div class="erp-banner-description" style="font-size: 0.75rem">
      Rotação automática: O sistema mantém os últimos 14 arquivos e deleta os
      mais antigos.
    </div>
  </div>

  <table class="erp-table">
    <thead>
      <tr>
        <th style="width: 50px">#</th>
        <th>Nome do Arquivo</th>
        <th>Tipo</th>
        <th>Data da Cópia</th>
        <th>Tamanho</th>
      </tr>
    </thead>
    <tbody>
      {% for b in backups %}
      <tr
        class="group cursor-pointer select-none"
        :class="{'selected': selectedItem && selectedItem.id == '{{ b.nome }}'}"
        @click="toggleSelection({
                        id: '{{ b.nome }}', 
                        nome: '{{ b.nome }}',
                        type: 'file'
                    })"
      >
        <td class="text-center text-gray-400 font-mono text-xs">
          {{ loop.index }}
        </td>

        <td class="font-mono font-semibold text-gray-700">{{ b.nome }}</td>

        <td>
          {% if '_auto' in b.nome %}
          <span class="badge badge-info">Automático</span>
          {% elif '_manual' in b.nome %}
          <span class="badge badge-neutral">Manual</span>
          {% else %}
          <span class="text-xs text-muted">-</span>
          {% endif %}
        </td>

        <td class="text-gray-600">{{ b.data }}</td>
        <td class="font-mono text-xs">{{ b.tamanho }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center py-12 text-muted">
          <i class="ph ph-database text-3xl mb-2 block opacity-20"></i>
          Nenhum backup encontrado. Gere o primeiro!
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="erp-footer justify-end text-xs">
    {{ backups|length }} arquivos armazenados (Local)
  </div>
</div>

<!-- Aba 2: Agendador de Tarefas -->
<div
  class="erp-grid-content"
  x-show="activeTab === 'servicos'"
  style="display: none"
>
  <div
    class="erp-banner erp-banner-info"
    style="padding: 0.5rem 1rem; margin-bottom: 0.5rem; border-radius: 0"
  >
    <i class="ph ph-info" style="font-size: 1.1rem"></i>
    <div class="erp-banner-description" style="font-size: 0.75rem">
      O agendador roda em background. Refresh manual necessário para ver
      progressão.
    </div>
  </div>

  <table class="erp-table">
    <thead>
      <tr>
        <th style="width: 50px">#</th>
        <th>Tarefa</th>
        <th>Próxima Execução</th>
        <th>Último Status</th>
        <th>Última Execução</th>
      </tr>
    </thead>
    <tbody>
      {% for job in jobs %}
      <tr
        class="group cursor-pointer select-none"
        :class="{'selected': selectedItem && selectedItem.id == '{{ job.id }}'}"
        @click="toggleSelection({
                        id: '{{ job.id }}', 
                        nome: '{{ job.id_amigavel }}',
                        type: 'job',
                        pausado: {{ 'true' if job.pausado else 'false' }}
                    })"
      >
        <td class="text-center text-gray-400 font-mono text-xs">
          {{ job.monitor.id if job.monitor else job.id }}
        </td>

        <td>
          <div class="flex flex-col">
            <span class="font-semibold text-gray-700"
              >{{ job.id_amigavel }}</span
            >
            <span class="text-xs text-gray-400 font-mono">{{ job.id }}</span>
          </div>
        </td>
        <td>
          {% if job.pausado %}
          <span class="badge badge-neutral">Pausado</span>
          {% else %}
          <span class="text-gray-600">{{ job.proxima_execucao }}</span>
          {% endif %}
        </td>
        <td>
          {% if job.monitor %} {% if job.monitor.status == 'Sucesso' %}
          <span class="badge badge-success"
            ><i class="ph ph-check-circle mr-1"></i> Sucesso</span
          >
          {% elif job.monitor.status == 'Erro' %}
          <span class="badge badge-danger" title="{{ job.monitor.mensagem }}"
            ><i class="ph ph-warning-octagon mr-1"></i> Erro</span
          >
          {% else %}
          <span class="badge badge-warning">{{ job.monitor.status }}</span>
          {% endif %} {% else %}
          <span class="text-gray-400 text-xs italic">Sem registros</span>
          {% endif %}
        </td>
        <td>
          <span class="text-gray-500 text-xs">
            {{ job.monitor.ultima_execucao.strftime('%d/%m/%Y %H:%M') if
            job.monitor and job.monitor.ultima_execucao else '-' }}
          </span>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center py-12 text-muted">
          <i class="ph ph-clock-countdown text-3xl mb-2 block opacity-20"></i>
          Nenhuma tarefa agendada encontrada.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="erp-footer justify-end text-xs">
    <span>{{ jobs|length }} tarefas configuradas</span>
  </div>
</div>

{% endcall %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Intercepta clique no botão de gerar backup (Toolbar)
    document.querySelectorAll(".backup-action").forEach((link) => {
      link.addEventListener("click", async function (e) {
        e.preventDefault();
        const message = this.dataset.confirmMessage || "Tem certeza?";
        const confirmed = await confirmAction(message, "warning");
        if (confirmed) {
          // Usa o loadUrl do componente Alpine se disponível, ou redireciona
          const alpineData = document.querySelector('[x-data="erpNavigation"]');
          if (alpineData && alpineData.__x && alpineData.__x.$data) {
            alpineData.__x.$data.loadUrl(this.href);
          } else {
            window.location.href = this.href;
          }
        }
      });
    });

    // Intercepta ações do agendador (Play/Pause/Resume)
    document.querySelectorAll(".job-action").forEach((link) => {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        const alpineData = document.querySelector('[x-data="erpNavigation"]');
        if (alpineData && alpineData.__x && alpineData.__x.$data) {
          alpineData.__x.$data.loadUrl(this.href);
        } else {
          window.location.href = this.href;
        }
      });
    });
  });
</script>

{% endblock %}
