{% extends "layout_base.html" %} 
{% from "componentes.html" import render_paginacao, render_layout_erp, th_ordenavel, badge_status_cliente %}

{% block title %}Clientes - HelpHub 4.0{% endblock %} 

{% block page_title %}
    Gerenciamento de Clientes 
    <span class="erp-subtitle hidden lg:inline-block">Base de cadastros ativos e prospecção</span>
{% endblock %}

{% block content %}
{% set toolbar_html %}
    <div x-show="activeTab === 'lista'" x-cloak class="flex items-center gap-2 w-full">
        <!-- Grupo A: Ações Principais -->
        <a href="{{ url_for('clientes.novo') }}" class="erp-btn erp-btn-primary">
            <i class="ph ph-plus-circle text-lg"></i> Novo
        </a>

        <div class="erp-separator"></div>

        <!-- Grupo B: Ações de Contexto (Dependentes de Seleção) -->
        <a :href="selectedItem ? '{{ url_for('clientes.editar', id=0) }}'.replace('0', selectedItem.id) : '#'"
           :class="selectedItem ? '' : 'disabled'"
           class="erp-btn erp-btn-neutral">
            <i class="ph ph-pencil-simple text-blue-600"></i> Editar
        </a>

        <button :class="selectedItem ? '' : 'disabled'"
                class="erp-btn erp-btn-neutral text-red-600"
                @click="if(selectedItem && await confirmAction('Excluir cliente ' + selectedItem.nome + '?', 'danger')) { alert('Exclusão via API'); }">
            <i class="ph ph-trash"></i> Deletar
        </button>

        <!-- Grupo C: Busca e Filtros (Direita) -->
        <div class="flex items-center gap-2 ml-auto">
            <form action="{{ url_for('clientes.lista') }}" method="get" class="flex items-center">
                <div class="erp-search-box">
                    <i class="ph ph-magnifying-glass"></i>
                    <input type="text" name="q" value="{{ q or '' }}" placeholder="Nome, Fantasia, CPF/CNPJ..." 
                           class="erp-search-input">
                </div>
            </form>
            <div class="erp-badge-count" title="Total de Registros">
                {{ clientes.total }} reg.
            </div>
        </div>
    </div>
{% endset %}


{# --- RENDERIZAÇÃO DO LAYOUT ERP --- #}
{% call render_layout_erp(
    titulo="Gerenciamento de Clientes",
    subtitulo="Base de cadastros ativos e prospecção.",
    abas=[
        {'id': 'lista', 'label': 'Carteira Atual', 'icon': 'ph-users'},
        {'id': 'placeholder', 'label': 'ADD NOVA ABA', 'icon': 'ph-plus-circle'}
    ],
    toolbar_buttons=toolbar_html
) %}

    <!-- CONTEÚDO DA GRID (Nível 2) -->
    
    <!-- Aba: LISTA -->
    <div x-show="activeTab === 'lista'" class="erp-grid-content">
        <table class="erp-table">
            <thead>
                <tr>
                    <th style="width: 40px;" class="text-center">#</th>
                    <th>Status</th>
                    {{ th_ordenavel('Razão Social / Nome', 'nome_razao', request.args.get('sort'), request.args.get('order')) }}
                    <th>Nome Fantasia</th>
                    <th>CPF / CNPJ</th>
                    <th>Cidade / UF</th>
                    <th>Endereço</th>
                    <th>Última Interação</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes.items %}
                <tr class="group cursor-pointer select-none"
                    :class="{'selected': selectedItem && selectedItem.id == '{{ cliente.id }}'}"
                    @click="toggleSelection({
                        id: '{{ cliente.id }}', 
                        nome: '{{ cliente.nome_razao | replace("'", "\\'") }}'
                    })"
                    @dblclick="window.location.href = '{{ url_for('clientes.editar', id=cliente.id) }}'">
                    
                    <td class="text-center text-gray-400 font-mono text-xs">{{ cliente.id }}</td>
                    
                    <td class="text-center">
                        {{ badge_status_cliente(cliente.ativo) }}
                    </td>
                    
                    <td class="font-semibold">{{ cliente.nome_razao }}</td>
                    <td>{{ cliente.nome_fantasia or '-' }}</td>
                    <td class="font-mono text-gray-600">{{ cliente.cpf_cnpj }}</td>
                    <td>{{ cliente.cidade }}/{{ cliente.uf }}</td>
                    <td class="text-xs text-gray-500 truncate max-w-[200px]">{{ cliente.logradouro }}, {{ cliente.numero }}</td>
                    <td class="text-xs text-gray-400">Há 2 dias</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-12 text-muted">Nenhum registro encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Rodapé Sticky da Grid -->
        <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-2">
             {{ render_paginacao(clientes, 'clientes.lista', q=q) }}
        </div>
    </div>

    <!-- Aba: Placeholder -->
    <div x-show="activeTab === 'placeholder'" class="p-12 text-center text-gray-400">
        <i class="ph ph-plus-circle text-3xl mb-3 block opacity-50"></i>
        <p>Espaço reservado para novas funcionalidades.</p>
    </div>

{% endcall %}

{% endblock %}
